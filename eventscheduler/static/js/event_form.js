// static/js/event_form.js
document.addEventListener('DOMContentLoaded', function() {
    const descriptionField = document.getElementById('id_description');
    const aiCheckbox = document.getElementById('id_generate_ai_description');
    
    if (descriptionField && aiCheckbox) {
        // Disable description field when AI checkbox is checked
        aiCheckbox.addEventListener('change', function() {
            descriptionField.disabled = this.checked;
            if (this.checked) {
                descriptionField.placeholder = 'Description will be generated by AI';
            } else {
                descriptionField.placeholder = '';
            }
        });
        
        // Initialize state on page load
        descriptionField.disabled = aiCheckbox.checked;
        if (aiCheckbox.checked) {
            descriptionField.placeholder = 'Description will be generated by AI';
        }
    }
    
    // Add a button to generate AI description on demand
    const descriptionContainer = document.querySelector('.form-field[for="id_description"]');
    if (descriptionContainer && !descriptionContainer.querySelector('.ai-generate-btn')) {
        const generateBtn = document.createElement('button');
        generateBtn.type = 'button';
        generateBtn.className = 'btn btn-sm btn-outline-secondary ai-generate-btn';
        generateBtn.textContent = 'Generate with AI';
        generateBtn.style.marginLeft = '10px';
        
        generateBtn.addEventListener('click', function() {
            const title = document.getElementById('id_title').value;
            const location = document.getElementById('id_location').value;
            
            if (!title) {
                alert('Please enter a title first');
                return;
            }
            
            generateBtn.disabled = true;
            generateBtn.textContent = 'Generating...';
            
            // Call the AI generation endpoint
            fetch('/event/generate-ai-description/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    title: title,
                    location: location
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.description) {
                    document.getElementById('id_description').value = data.description;
                } else {
                    alert('Failed to generate description');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to generate description');
            })
            .finally(() => {
                generateBtn.disabled = false;
                generateBtn.textContent = 'Generate with AI';
            });
        });
        
        descriptionContainer.appendChild(generateBtn);
    }
});

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}